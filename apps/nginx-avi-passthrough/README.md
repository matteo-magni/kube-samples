# End-to-end encrypted communication

This example shows how to have a full end-to-end encryption between the client and backend service,
using VMware AVI Load Balancer.

Normally, the load balancer would terminate the TLS connection,
and would talk unencrypted to the backend service.
This example shows how to instruct AVI to re-encrypt the communication,
but then the backend service needs to handle the burden of terminating TLS.

## Backend service configuration

[Unprivileged nginx](https://hub.docker.com/r/nginxinc/nginx-unprivileged) has been chosen as the sample backend application,
and some [configuration files](./files) have been provided to properly tune it.
In order to test this example, some changes have to be applied:

- `default.conf`: nginx default configuration file, the `server_name` directives must be changed according to the app's URL
- `tls.crt`: TLS certificate full chain for the app's domain. It must be composed of the leaf certificate first, followed by all the CA certificates that validate the chain
- `tls.key`: the private key of the aforementioned TLS leaf certificate

## Ingress configuration

The [ingress resource](./ingress.yaml) must specify the `passthrough.ako.vmware.com/enabled: "true"` annotation,
and the actual app's domain must be present in both the `rules` and `tls` sections.
The `the-tls-secret` secret is generated by Kustomize, and must not be changed.

The `HostRule` resource, if needed, must also be accordingly changed,
specifying the correct fqdn, aliases (if any) and policies (if any).

A `HTTPRule` is necessary in this case, to instruct the AVI Load Balancer to talk TLS to the backend service,
as well as to explicitly specify which CA certificates must be trusted
when validating the destination service's certificate.
The `fqdn` field must be adjusted along with the `destinationCA` string.

## Kustomize

The `kustomization.yaml` file is glueing all the components together:
it generates the `nginx-conf` configmap for Nginx's configuration file
and the `the-tls-secret` secret for the tls key and certificate,
then mounts them all to the app container.

The `the-tls-secret` is also used by the ingress resource.
